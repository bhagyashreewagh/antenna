#!/bin/bash

# --- ENABLE DEBUGGING MODE ---
set -o errexit
set -o pipefail
set -o nounset
set -o xtrace  # echo each command before executing it

echo "===== ENTRYPOINT START ====="
echo "Current user: $(whoami)"
echo "Working directory: $(pwd)"
echo "Python version: $(python --version 2>&1)"
echo "Listing current directory contents:"
ls -alh

# --- HARDCODED SECRETS (TEMPORARY FOR DEBUGGING) ---
echo "Exporting environment variables..."
export REDIS_URL="rediss://master.antenna-redis.k9ptee.usw2.cache.amazonaws.com:6379/0"
export CELERY_BROKER_URL="${CELERY_BROKER_URL:-${REDIS_URL}}"

export POSTGRES_USER="postgres"
export POSTGRES_PASSWORD="ssec_postgres_2025"
export POSTGRES_DB="postgres"
export POSTGRES_HOST="antenna-postgres-1.cb0g0q8ayknd.us-west-2.rds.amazonaws.com"
export POSTGRES_PORT="5432"

export DATABASE_URL="postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}"

echo "Environment setup complete."
echo "DATABASE_URL: ${DATABASE_URL}"

# --- WAIT FOR POSTGRESQL ---
echo "Checking PostgreSQL connectivity..."

python <<END
import sys, time, psycopg, os

print("Starting PostgreSQL connection check...", flush=True)
start = time.time()
timeout = 60
attempt = 0

while True:
    attempt += 1
    try:
        conn = psycopg.connect(
            dbname=os.environ["POSTGRES_DB"],
            user=os.environ["POSTGRES_USER"],
            password=os.environ["POSTGRES_PASSWORD"],
            host=os.environ["POSTGRES_HOST"],
            port=int(os.environ["POSTGRES_PORT"]),
            connect_timeout=5
        )
        conn.close()
        print(f"[Attempt {attempt}] ✅ PostgreSQL is available!", flush=True)
        break
    except Exception as error:
        print(f"[Attempt {attempt}] ❌ Waiting for PostgreSQL... {error}", flush=True)
        if time.time() - start > timeout:
            print("❌ Timeout reached. Exiting with failure.", flush=True)
            sys.exit(1)
        time.sleep(2)
END

echo "✅ PostgreSQL connection successful."
echo "===== STARTING DJANGO APP ====="

# --- START DJANGO APP ---
echo "Executing command: $@"
exec "$@"
